@model Cinema.Models.ViewModels.CheckoutViewModel

@{
    ViewData["Title"] = "Escolha de Assentos";
    var takenSeats = ViewBag.TakenSeats as List<string> ?? new List<string>();
    int rows = Model.Session?.Room?.Rows ?? 8;
    int cols = Model.Session?.Room?.Columns ?? 10;
    string[] rowLetters = { "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M" };
}

<div class="container py-5">
    <!-- Progress Bar -->
    <div class="position-relative mb-5">
        <div class="progress" style="height: 4px;">
            <div class="progress-bar bg-warning" role="progressbar" style="width: 50%;" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="position-absolute top-0 start-0 translate-middle btn btn-sm btn-warning rounded-circle shadow fw-bold" style="width: 30px; height: 30px;">1</div>
        <div class="position-absolute top-0 start-25 translate-middle btn btn-sm btn-warning rounded-circle shadow fw-bold" style="width: 30px; height: 30px;">2</div>
        <div class="position-absolute top-0 start-50 translate-middle btn btn-sm btn-secondary rounded-circle shadow fw-bold" style="width: 30px; height: 30px;">3</div>
        <div class="position-absolute top-0 start-75 translate-middle btn btn-sm btn-secondary rounded-circle shadow fw-bold" style="width: 30px; height: 30px;">4</div>
        <div class="position-absolute top-0 start-100 translate-middle btn btn-sm btn-secondary rounded-circle shadow fw-bold" style="width: 30px; height: 30px;">5</div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card bg-dark text-white border-secondary shadow-lg">
                <div class="card-header border-secondary bg-black bg-opacity-50 p-4 d-flex justify-content-between align-items-center">
                    <h2 class="h4 mb-0 fw-bold text-uppercase border-start border-4 border-warning ps-3">
                        <i class="fas fa-couch me-2 text-white-50"></i>Escolha seus Assentos
                    </h2>
                    <div class="text-end">
                        <small class="text-white-50 d-block">Selecionados: <span id="selectedCount" class="text-white fw-bold">0</span> / @Model.TotalTickets</small>
                    </div>
                </div>

                <div class="card-body p-4 text-center">
                    <!-- Screen -->
                    <div class="mb-5">
                        <div class="screen bg-light text-dark fw-bold text-uppercase py-1 mb-3 mx-auto shadow-sm" style="width: 80%; border-radius: 0 0 50px 50px; opacity: 0.1;">TELA</div>
                    </div>

                    <form asp-action="Step2" method="post" id="seatForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4"></div>
                        <input type="hidden" name="selectedSeatsJson" id="selectedSeatsJson" />

                        <!-- Seat Map -->
                        <div class="d-inline-block p-4 bg-black bg-opacity-25 rounded border border-secondary mb-4">
                            @for (int r = 0; r < rows; r++)
                            {
                                <div class="d-flex justify-content-center gap-2 mb-2">
                                    <span class="text-white-50 fw-bold d-flex align-items-center justify-content-center" style="width: 30px;">@rowLetters[r]</span>
                                    @for (int c = 1; c <= cols; c++)
                                    {
                                        string seatId = rowLetters[r] + c;
                                        bool isTaken = takenSeats.Contains(seatId);
                                        
                                        <button type="button" 
                                                class="btn btn-sm seat-btn @(isTaken ? "btn-danger disabled" : "btn-outline-secondary")" 
                                                style="width: 35px; height: 35px;"
                                                data-seat="@seatId"
                                                @(isTaken ? "disabled" : "")
                                                onclick="toggleSeat(this)">
                                            @c
                                        </button>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Legend -->
                        <div class="d-flex justify-content-center gap-4 mb-4 small text-uppercase fw-bold">
                            <div class="d-flex align-items-center gap-2">
                                <span class="bg-secondary rounded border border-secondary" style="width: 20px; height: 20px; display:block;"></span> Livre
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="bg-warning rounded border border-warning" style="width: 20px; height: 20px; display:block;"></span> Selecionado
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="bg-danger rounded border border-danger opacity-50" style="width: 20px; height: 20px; display:block;"></span> Ocupado
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="d-flex justify-content-between">
                            <a asp-action="Step1" class="btn btn-outline-light rounded-pill px-4">
                                <i class="fas fa-arrow-left me-2"></i>Voltar
                            </a>
                            <button type="submit" class="btn btn-warning rounded-pill px-5 fw-bold shadow-lg" id="btnNext" disabled>
                                Escolher Lanche <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const totalTickets = @Model.TotalTickets;
    let selectedSeats = [];

    function toggleSeat(btn) {
        const seat = btn.getAttribute('data-seat');
        
        if (selectedSeats.includes(seat)) {
            // Unselect
            selectedSeats = selectedSeats.filter(s => s !== seat);
            btn.classList.remove('btn-warning', 'text-dark', 'fw-bold', 'border-warning');
            btn.classList.add('btn-outline-secondary');
        } else {
            // Select
            if (selectedSeats.length >= totalTickets) {
                alert('Você já selecionou todos os ingressos disponíveis.');
                return;
            }
            selectedSeats.push(seat);
            btn.classList.add('btn-warning', 'text-dark', 'fw-bold', 'border-warning');
            btn.classList.remove('btn-outline-secondary');
        }

        updateUI();
    }

    function updateUI() {
        document.getElementById('selectedCount').innerText = selectedSeats.length;
        document.getElementById('selectedSeatsJson').value = selectedSeats.join(',');
        
        const btnNext = document.getElementById('btnNext');
        if (selectedSeats.length === totalTickets) {
            btnNext.disabled = false;
        } else {
            btnNext.disabled = true;
        }
    }
</script>
