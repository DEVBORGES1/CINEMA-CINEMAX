@model Cinema.Models.ViewModels.CheckoutViewModel
@{
    ViewData["Title"] = "Bombonière - Escolha seus Lanches";
    var allSnacks = ViewBag.AllSnacks as List<Cinema.Models.Snack> ?? new List<Cinema.Models.Snack>();
}

<div class="container py-5">
    <!-- Progress Bar -->
    <div class="position-relative mb-5">
        <div class="progress" style="height: 4px;">
            <div class="progress-bar bg-warning" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="position-absolute top-0 start-0 translate-middle btn btn-sm btn-warning rounded-circle shadow fw-bold" style="width: 30px; height: 30px;">1</div>
        <div class="position-absolute top-0 start-25 translate-middle btn btn-sm btn-warning rounded-circle shadow fw-bold" style="width: 30px; height: 30px;">2</div>
        <div class="position-absolute top-0 start-50 translate-middle btn btn-sm btn-warning rounded-circle shadow fw-bold" style="width: 30px; height: 30px;">3</div>
        <div class="position-absolute top-0 start-75 translate-middle btn btn-sm btn-secondary rounded-circle shadow fw-bold" style="width: 30px; height: 30px;">4</div>
        <div class="position-absolute top-0 start-100 translate-middle btn btn-sm btn-secondary rounded-circle shadow fw-bold" style="width: 30px; height: 30px;">5</div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card bg-dark text-white border-secondary shadow-lg">
                <div class="card-header border-secondary bg-black bg-opacity-50 p-4 d-flex justify-content-between align-items-center">
                    <h2 class="h4 mb-0 fw-bold text-uppercase border-start border-4 border-warning ps-3">
                        <i class="fas fa-popcorn me-2 text-white-50"></i>Vai uma pipoca aí?
                    </h2>
                    <div class="text-end">
                        <small class="text-white-50">Total Estimado:</small>
                        <h4 class="fw-bold text-warning mb-0" id="totalPreview">R$ @Model.TotalPrice.ToString("N2")</h4>
                    </div>
                </div>

                <div class="card-body p-4">
                    <form asp-action="Step3" method="post">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4"></div>

                        <div class="row g-4">
                            @foreach(var snack in allSnacks)
                            {
                                int currentQty = Model.SelectedSnacks.FirstOrDefault(s => s.SnackID == snack.ID)?.Quantity ?? 0;
                                
                                <div class="col-md-6 col-lg-4">
                                    <div class="card bg-black bg-opacity-25 border-secondary h-100 snack-card">
                                        <div class="position-relative overflow-hidden" style="height: 180px;">
                                            @if(!string.IsNullOrEmpty(snack.ImageURL)) {
                                                <img src="@snack.ImageURL" class="card-img-top h-100 w-100" alt="@snack.Name" style="object-fit: contain; padding: 1rem;">
                                            } else {
                                                <div class="d-flex align-items-center justify-content-center h-100 text-white-50">
                                                    <i class="fas fa-utensils fa-3x"></i>
                                                </div>
                                            }
                                            <span class="badge bg-warning text-dark position-absolute top-0 end-0 m-2 fw-bold shadow-sm">
                                                R$ @snack.Price.ToString("N2")
                                            </span>
                                        </div>
                                        
                                        <div class="card-body text-center d-flex flex-column">
                                            <h5 class="card-title fw-bold mb-1">@snack.Name</h5>
                                            <p class="card-text text-muted small mb-3 flex-grow-1">@snack.Description</p>
                                            
                                            <div class="d-flex justify-content-center align-items-center gap-3">
                                                <button type="button" class="btn btn-sm btn-outline-secondary rounded-circle" style="width: 32px; height: 32px;" onclick="changeQty(@snack.ID, -1, @snack.Price)">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" name="snacks[@snack.ID]" id="qty_@snack.ID" value="@currentQty" min="0" max="10" 
                                                       class="form-control form-control-sm bg-dark text-white border-0 text-center fw-bold fs-5 p-0" 
                                                       style="width: 40px;" readonly>
                                                <button type="button" class="btn btn-sm btn-outline-warning rounded-circle" style="width: 32px; height: 32px;" onclick="changeQty(@snack.ID, 1, @snack.Price)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Actions -->
                        <div class="d-flex justify-content-between mt-5">
                            <a asp-action="Step2" class="btn btn-outline-light rounded-pill px-4">
                                <i class="fas fa-arrow-left me-2"></i>Voltar
                            </a>
                            <button type="submit" class="btn btn-warning rounded-pill px-5 fw-bold shadow-lg">
                                Ir para Pagamento <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let baseTotal = @Model.TotalPrice.ToString("F2").Replace(",", "."); // Base ticket price
    // Note: total passed in Model might ALREADY include snacks if we went back.
    // For simplicity, let's assume we re-calculate on client side or just show rough estimate.
    
    // Better logic: Calculate ticket cost separately, then add dynamic snack cost.
    // Since we don't have separate TicketTotal in viewmodel easily available (VM has TotalPrice), 
    // let's just update the visual "Total" by adding changes.
    
    // Actually, let's recalculate live.
    const ticketTotal = baseTotal - (@Model.SelectedSnacks.Sum(s => s.Price * s.Quantity).ToString("F2").Replace(",", ".") || 0);

    function changeQty(id, delta, price) {
        const input = document.getElementById('qty_' + id);
        let val = parseInt(input.value);
        val += delta;
        if (val < 0) val = 0;
        if (val > 10) val = 10;
        input.value = val;
        
        updateTotal();
    }

    function updateTotal() {
        let snackTotal = 0;
        document.querySelectorAll('input[name^="snacks["]').forEach(input => {
            const qty = parseInt(input.value);
            // find price - clumsy but works if we iterate all buttons or store map
            // Easier: look at the badge or passed args.
            // Let's re-select based on DOM structure relative to input? 
            // Or just trust the user will see the total on next page properly.
            // Implementing live total requires price metadata on inputs.
        });
        
        // Simplified Live Total:
        // We need to know which input maps to which price.
    }
</script>
